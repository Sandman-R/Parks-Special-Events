# Result

```{r}
#| warning: false
#| message: false

library(dplyr)
library(ggplot2)
library(vcd)
library(stringr)
library(lubridate)
library(forcats)
library(readr)
library(tidyr)
library(purrr)
library(sf)
library(RColorBrewer)
library(grid)
library(ggalluvial)
library(ggridges)
library(tigris)
library(patchwork)

df <- read.csv("Parks_Special_Events_20251027.csv") 
parks <- read.csv("Parks_Properties_20251209.csv") 
parks <- parks |>
  mutate(
    geometry = st_as_sfc(multipolygon)
  ) |>
  st_as_sf(crs = 4326)
```

## Preprocessing

```{r}
#| warning: false
#| message: false

theme_edav <- function(base_size = 14, base_family = "Helvetica") {
  theme_minimal(base_size = base_size, base_family = base_family) +
    theme(
      panel.grid = element_blank(),
      axis.line = element_line(color = "black", linewidth = 0.6),
      axis.title = element_text(face = "bold"),
      plot.title = element_text(face = "bold", size = base_size + 2),
      
      legend.key.height = unit(0.6, "cm"),
      legend.key.width  = unit(0.6, "cm"),
      legend.title = element_text(face = "bold"),
      
      panel.border = element_blank()
    )
}

theme_set(theme_edav())

options(tigris_use_cache = TRUE)

ny_counties <- counties(state = "NY", cb = TRUE, year = 2020) |>
  st_transform(4326)

nyc_outline <- ny_counties |>
  filter(NAME %in% c("New York", "Kings", "Queens", "Bronx", "Richmond"))

df <- df |>
  mutate(
    datetime = mdy_hms(Date.and.Time),
    year     = year(datetime),
    month    = month(datetime, label = TRUE, abbr = TRUE),  
    dow      = wday(datetime, label = TRUE, abbr = TRUE),    
    hour     = hour(datetime),
    doy      = yday(datetime),
    Attendance_num = parse_number(as.character(Attendance)),
    Attendance_num = ifelse(Attendance_num < 0, NA, Attendance_num)
  ) |>
  filter(year != 2002 & LocationType == "Park") |>
  mutate(
    park_clean = Location |>
      tolower() |>                
      str_replace_all("[^a-z0-9 ]", " ") |>  
      str_squish()                
  )

# head(df)
```

## Barplot

```{r}
#| warning: false
#| message: false
events_by_month <- df |>
  count(month, name = "n") |>
  arrange(month)

ggplot(events_by_month, aes(x = month, y = n)) +
  geom_col() +
  labs(
    title = "Number of Events by Month",
    x = "Month",
    y = "Number of Events"
  ) +
  theme_edav()

```

## Ridge

```{r}
#| warning: false
#| message: false

top8_cat <- df |>
  count(Category, sort = TRUE) |>
  slice_head(n = 8) |>
  pull(Category)

df_top <- df |>
  filter(Category %in% top8_cat)

ggplot(df_top, aes(x = doy, y = Category, fill = Category)) +
  geom_density_ridges(alpha = 0.7, scale = 1.5) +
  labs(
    title = "Seasonal Distribution of Events by Category (Top 8)",
    x = "Day of Year",
    y = "Category"
  ) +
  theme_edav()
```

## Hex Heatmap

```{r}
#| warning: false
#| message: false

df_hex <- df |>
  filter(!is.na(Attendance_num), !is.na(doy)) |>
  mutate(
    Attendance_capped = pmin(
      Attendance_num,
      quantile(Attendance_num, 0.99, na.rm = TRUE)
    )
  )

ggplot(df_hex, aes(x = doy, y = Attendance_capped)) +
  geom_hex(bins = 20, color = NA) +
  scale_y_log10() +
  scale_fill_gradientn(
  colours = c("#e0f3f8", "#abd9e9", "#74add1", "#4575b4", "#313695"),
  # trans   = "log10",
  name    = "Count"
) +
  labs(
    title = "Attendance vs Day-of-Year",
    x = "Day of Year",
    y = "Attendance",
    fill = "Count"
  )
```

## Alluvial 1

```{r}
df_year <- df |>
  filter(!is.na(year), year >= 2019, !is.na(Category))

top_cat <- df_year |>
  count(Category, sort = TRUE) |>
  slice_head(n = 7) |>
  pull(Category)

df_year_filtered <- df_year |>
  filter(Category %in% top_cat)

summary_df_year <- df_year_filtered |>
  group_by(year, Category) |>
  summarise(
    total_events = n(),
    .groups = "drop"
  ) |>
  mutate(
    year     = factor(year),
    Category = fct_infreq(Category)
  )
```

```{r}
ggplot(
  summary_df_year,
  aes(
    x        = year,
    stratum  = Category,
    alluvium = Category,
    y        = total_events,
    fill     = Category
  )
) +
  geom_flow(
    stat          = "alluvium",
    lode.guidance = "frontback",
    color         = "grey60",
    alpha         = 0.8
  ) +
  geom_stratum(width = 0.3, color = "grey30") +
  scale_fill_brewer(palette = "Set2", name = "Category") +
  labs(
    title = "NYC Event Categories Over Time",
    x     = "Year",
    y     = "Number of Events"
  ) +
  theme_edav()
```

## Alluvial 2

```{r}
df_year <- df |>
  filter(!is.na(year), year >= 2019, !is.na(Category))

top_cat <- df_year |>
  count(Category, sort = TRUE) |>
  slice_head(n = 7) |>
  pull(Category)

df_year_filtered <- df_year |>
  filter(Category %in% top_cat)

summary_df_year_att <- df_year_filtered |>
  group_by(year, Category) |>
  summarise(
    total_attendance = sum(Attendance_num, na.rm = TRUE),
    .groups = "drop"
  ) |>
  mutate(
    year     = factor(year),
    Category = fct_infreq(Category)
  )
```

```{r}
ggplot(
  summary_df_year_att,
  aes(
    x        = year,
    stratum  = Category,
    alluvium = Category,
    y        = total_attendance,
    fill     = Category
  )
) +
  geom_flow(
    stat          = "alluvium",
    lode.guidance = "frontback",
    color         = "grey60",
    alpha         = 0.8
  ) +
  geom_stratum(width = 0.3, color = "grey30") +
  scale_fill_brewer(palette = "Set2", name = "Category") +
  labs(
    title = "NYC Event Categories by Total Attendance Over Time",
    x     = "Year",
    y     = "Total Attendance"
  ) +
  theme_edav()
```

## Spatial


```{r}
#| warning: false
#| message: false
parks <- parks |>
  mutate(
    park_clean = NAME311 |>      
      tolower() |>
      str_replace_all("[^a-z0-9 ]", " ") |>
      str_squish()
  )

theme_hex_small <- function() {
  theme_minimal(base_size = 8) +
    theme(
      axis.text  = element_blank(),
      axis.title = element_blank(),
      axis.ticks = element_blank(),
      panel.grid = element_blank(),
      plot.title = element_text(size = 10, face = "bold", hjust = 0.5),
      legend.title = element_text(size = 8),
      legend.text  = element_text(size = 7),
      legend.key.height = unit(0.3, "in"),
      legend.key.width  = unit(0.15, "in")
    )
}

plot_hex_for_year <- function(year_sel, pal) {

  park_attendance_year <- df |>
    filter(year == year_sel, !is.na(park_clean)) |>
    group_by(park_clean) |>
    summarise(total_attendance = sum(Attendance_num, na.rm = TRUE)) |>
    ungroup()

  parks_joined_year <- parks |>
    left_join(park_attendance_year, by = "park_clean") |>
    mutate(total_attendance = replace_na(total_attendance, 0))

  parks_valid_year <- parks_joined_year |>
    st_make_valid()

  parks_pts_year <- parks_valid_year |>
    st_centroid(of_largest_polygon = TRUE) |>
    mutate(
      lon = st_coordinates(geometry)[, 1],
      lat = st_coordinates(geometry)[, 2]
    ) |>
    st_drop_geometry()

  ggplot() +
    stat_summary_hex(
      data = parks_pts_year,
      aes(x = lon, y = lat, z = total_attendance),
      bins  = 20,
      fun   = "sum",
      color = NA
    ) +
    scale_fill_gradientn(
      colours = pal,
      name    = "Total Attendance"
    ) +
    geom_sf(
      data      = nyc_outline,
      fill      = NA,
      color     = "grey70",
      linewidth = 0.4
    ) +
    coord_sf() +
    labs(
      title = paste("NYC Events Attendance in", year_sel),
      x     = "Longitude",
      y     = "Latitude"
    ) +
    theme_hex_small()
}
```

```{r}
#| warning: false
#| message: false

pal_blue <- c("#e0f3f8", "#abd9e9", "#74add1", "#4575b4", "#313695")
pal_red  <- c("#fee5d9", "#fcae91", "#fb6a4a", "#de2d26", "#a50f15")

p2019 <- plot_hex_for_year(2019, pal_blue)
p2020 <- plot_hex_for_year(2020, pal_red)
p2021 <- plot_hex_for_year(2021, pal_blue)
p2022 <- plot_hex_for_year(2022, pal_blue)

(p2019 + p2020) / (p2021 + p2022)
```
